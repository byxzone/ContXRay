## 容器安全

容器是一种应用层抽象，用于将代码和依赖资源打包在一起。多个容器可以在同一台机器上运行，共享操作系统内核，但各自作为独立的进程在用户空间中运行。与虚拟机相比，容器占用的空间比较少，启动速度非常快。

容器技术面临的新挑战：

- 容器共享宿主机内核，隔离性相对较弱！

- 有 root 权限的用户可以访问所有容器资源！某容器提权后可能影响全局！

- 容器在主机网络之上构建了一层 Overlay 网络，使容器间的互访避开了传统网络安全的防护！

- 容器的弹性伸缩性，使有些容器只是短暂运行，短暂运行的容器行为异常不容易被发现！

- 容器和容器编排给系统增加了新的元素,带来新的风险

### 容器逃逸

在容器安全问题中，容器逃逸是最为严重，它直接影响到了承载容器的底层基础设施的保密性、完整性和可用性。下面的情况会导致容器逃逸：

- 危险配置导致容器逃逸。

在这些年的迭代中，容器社区一直在努力将「纵深防御」、「最小权限」等理念和原则落地。例如，Docker 已经将容器运行时的 Capabilities 黑名单机制改为如今的默认禁止所有 Capabilities，再以白名单方式赋予容器运行所需的最小权限。如果容器启动，配置危险能力，或特权模式容器，或容器以 root 用户权限运行都会导致容器逃逸。

- 危险挂载导致容器逃逸。

Docker Socket 是 Docker 守护进程监听的 Unix 域套接字，用来与守护进程通信——查询信息或下发命令。如果在攻击者可控的容器内挂载了该套接字文件（/var/run/docker.sock），容器逃逸就相当容易了，除非有进一步的权限限制。

- 相关程序漏洞导致容器逃逸。

例如：runc 漏洞 CVE-2019-5736 导致容器逃逸。

- 内核漏洞导致容器逃逸。

例如：Copy_on_Write 脏牛漏洞，向 vDSO 内写入 shellcode 并劫持正常函数的调用过程，导致容器逃逸。

### 保障容器安全

确保容器运行时安全的关键点：

- 降低容器的攻击面，每个容器以最小权限运行，包括容器挂载的文件系统、网络控制、运行命令等。

- 确保每个用户对不同的容器拥有合适的权限。

- 使用安全容器控制容器之间的访问。当前，Linux 的 Docker 容器技术隔离技术采用 Namespace 和 Cgroups 无法阻止提权攻击或打破沙箱的攻击。

- 使用 ebpf 跟踪技术自动生成容器访问控制权限。包括：容器对文件的可疑访问，容器对系统的可疑调用，容器之间的可疑互访，检测容器的异常进程，对可疑行为进行取证。例如：

​       (1) 检测容器运行时是否创建其他进程。

​       (2) 检测容器运行时是否存在文件系统读取和写入的异常行为，例如在运行的容器中安装了新软件包或者更新配置。

​       (3) 检测容器运行时是否打开了新的监听端口或者建立意外连接的异常网络活动。

​       (4)检测容器中用户操作及可疑的 shell 脚本的执行。

为了增强容器的安全性，已有几种安全策略已经部署到容器环境中，在保证容器正常行为的前提下，极大限制了恶意攻击者的行为。例如：

- Iptables管理对容器网络的访问控制
- capability机制切割root权限，保证容器即使被攻击者控制，也将攻击行为限制在某一权限内
- seccomp限制用户进程可用的系统调用列表，以防止攻击者滥用不必要的系统调用。

### 参考资料:

基于eBPF实现容器运行时安全(https://www.ebpf.top/post/ebpf_container_security/)